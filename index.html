<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Judoka</title>

  <style>
    :root{
      --bg:#07070a;
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.64);
      --shadow:0 26px 90px rgba(0,0,0,.60);
      --r:26px;

      --blue: rgba(10,132,255,1);
      --ok: rgba(52,199,89,1);
      --glass1: rgba(255,255,255,.14);
      --glass2: rgba(255,255,255,.08);
      --sep: rgba(255,255,255,.10);

      --grad: linear-gradient(90deg, rgba(10,132,255,.95), rgba(88,86,214,.95), rgba(255,45,85,.92));
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      padding:
        calc(18px + env(safe-area-inset-top))
        16px
        calc(20px + env(safe-area-inset-bottom))
        16px;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 12% 8%, rgba(120,80,255,.48), transparent 62%),
        radial-gradient(900px 760px at 88% 16%, rgba(0,200,255,.36), transparent 60%),
        radial-gradient(900px 800px at 40% 92%, rgba(255,80,160,.28), transparent 66%),
        var(--bg);
      overflow-x:hidden;
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:-40px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      opacity:.10;
      pointer-events:none;
    }

    .wrap{width:100%;max-width:660px;margin:0 auto}

    .card{
      border-radius:var(--r);
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--glass1), var(--glass2));
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
    }

    /* header inside card (no truncation) */
    .cardHead{
      padding:18px 18px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.08);
      text-align:center;
    }
    .title{
      margin:0 0 6px;
      font-weight:980;
      letter-spacing:-.04em;
      font-size:30px;
      line-height:1.08;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    /* ===== WOW progress (QUI-like) ===== */
    .progressWrap{
      padding:18px 18px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.06);
      position:relative;
      overflow:hidden;
    }

    /* wave that runs when a step completes */
    .progressWrap.wave:after{
      content:"";
      position:absolute;
      left:-30%;
      top:0;
      width:30%;
      height:100%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
      transform:skewX(-18deg);
      animation: wave 620ms ease forwards;
      pointer-events:none;
    }
    @keyframes wave{
      to{ left:110%; }
    }

    .qui{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .node{
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      width:30px; height:30px;
      cursor:pointer;
      user-select:none;
    }

    .dot{
      width:28px;height:28px;border-radius:999px;
      border:2px solid rgba(255,255,255,.26);
      background:rgba(0,0,0,.18);
      box-shadow:0 14px 32px rgba(0,0,0,.22);
      position:relative;
      transition:transform .18s ease, border-color .18s ease, background .18s ease, box-shadow .18s ease;
    }

    /* active pulse ring */
    .node.active .dot{
      border-color: rgba(10,132,255,.92);
      box-shadow:0 0 0 8px rgba(10,132,255,.14), 0 16px 34px rgba(0,0,0,.26);
      transform:scale(1.04);
    }
    .node.active .dot:after{
      content:"";
      position:absolute; inset:-10px;
      border-radius:999px;
      border:1px solid rgba(10,132,255,.22);
      opacity:.0;
      animation:pulse 1.35s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{opacity:0; transform:scale(.95)}
      35%{opacity:.9}
      100%{opacity:0; transform:scale(1.16)}
    }

    /* done = green fill + check */
    .node.done .dot{
      background:rgba(52,199,89,.92);
      border-color:rgba(52,199,89,.98);
      box-shadow:0 0 0 8px rgba(52,199,89,.12), 0 16px 34px rgba(0,0,0,.24);
    }
    .node.done .dot:before{
      content:"‚úì";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      font-size:15px;
      color:white;
      text-shadow:0 10px 20px rgba(0,0,0,.35);
    }
    /* little pop when a step becomes done */
    .node.pop .dot{ animation: pop 260ms cubic-bezier(.2,.9,.2,1); }
    @keyframes pop{
      0%{transform:scale(.92)}
      60%{transform:scale(1.14)}
      100%{transform:scale(1)}
    }

    .line{
      height:4px;
      flex:1;
      border-radius:999px;
      background:rgba(255,255,255,.18);
      overflow:hidden;
      position:relative;
    }
    .line > i{
      display:block;
      height:100%;
      width:0%;
      background:var(--grad);
      border-radius:999px;
      transition:width .25s ease;
      position:relative;
    }
    .line > i:after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.16), rgba(255,255,255,0));
      transform:translateX(-45%);
      animation: shine 1.6s linear infinite;
      opacity:.95;
    }
    @keyframes shine{ to{ transform:translateX(45%);} }

    /* ===== sheet ===== */
    .sec{ padding:18px; }

    .sheet{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      border-radius:22px;
      overflow:hidden;
    }

    .sheetTop{
      padding:16px 16px 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .badge{
      width:32px;height:32px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      font-weight:1000;
      font-size:13px;
      box-shadow:0 14px 32px rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .titles{ min-width:0; }
    .stepTitle{
      margin:0;
      font-size:18px;
      font-weight:980;
      letter-spacing:-.02em;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stepSub{
      margin:7px 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
    }
    .divider{ height:1px; background:var(--sep); }

    .fieldArea{
      padding:16px;
      overflow:hidden;
      position:relative;
    }

    /* spring-like slide */
    .stage{
      display:grid;
      gap:10px;
      opacity:1;
      transform:translateY(0) scale(1);
      transition:opacity .22s ease, transform .34s cubic-bezier(.2,.9,.2,1);
    }
    .fieldArea.out .stage{
      opacity:0;
      transform:translateY(-12px) scale(.99);
      pointer-events:none;
    }
    .fieldArea.in .stage{
      opacity:0;
      transform:translateY(12px) scale(.99);
    }

    .field{ position:relative; }
    input, select{
      width:100%;
      padding:15px 46px 15px 14px;
      font-size:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      -webkit-appearance:none;
      appearance:none;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus{
      border-color:rgba(10,132,255,.55);
      box-shadow:0 0 0 7px rgba(10,132,255,.14);
    }
    input::placeholder{ color:rgba(255,255,255,.28); }

    /* iOS chevron for select */
    .field.select:after{
      content:"‚åÑ";
      position:absolute;
      right:16px;
      top:50%;
      transform:translateY(-55%);
      color:rgba(255,255,255,.70);
      font-size:18px;
      pointer-events:none;
    }

    .check{
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%) scale(.92);
      width:24px;height:24px;
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      color:rgba(255,255,255,.9);
      font-size:14px;
      opacity:0;
      transition:opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    .check.show{
      opacity:1;
      transform:translateY(-50%) scale(1);
      border-color:rgba(52,199,89,.42);
      box-shadow:0 0 0 7px rgba(52,199,89,.10);
    }

    .nav{
      display:flex;
      gap:10px;
      padding:16px;
      border-top:1px solid var(--sep);
      background:rgba(0,0,0,.08);
    }
    .btn{
      flex:1;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.16);
      color:rgba(255,255,255,.92);
      font-size:15px;
      font-weight:980;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, box-shadow .16s ease, border-color .16s ease, background .16s ease;
    }
    .btn:active{ transform:scale(.99); }
    .btn.primary{
      border-color:rgba(10,132,255,.25);
      background:linear-gradient(180deg, rgba(10,132,255,.22), rgba(0,0,0,.12));
      box-shadow:0 16px 44px rgba(10,132,255,.08);
    }
    .btn[disabled]{
      opacity:.42;
      cursor:not-allowed;
      box-shadow:none;
      background:rgba(0,0,0,.12);
    }

    /* ===== QR (compact) ===== */
    .qrBox{
      padding:14px 18px 18px;
      border-top:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.10);
      text-align:center;
    }
    .tip{
      margin:0 0 10px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.14);
      color:rgba(255,255,255,.86);
      font-size:13px;
      line-height:1.35;
    }
    .tip b{ color:rgba(255,255,255,.96); }

    .qrFrame{
      margin:8px auto 0;
      width:min(270px,80%);
      aspect-ratio:1/1;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(180px 180px at 30% 25%, rgba(255,255,255,.10), transparent 60%),
        rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      position:relative;
    }

    #qr{
      width:100%;height:100%;
      object-fit:contain;
      display:none;
      opacity:0;
      transform:scale(.86) rotate(-4deg);
      filter:drop-shadow(0 16px 42px rgba(0,0,0,.42));
    }
    #qr.reveal{
      display:block;
      animation: reveal .68s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes reveal{
      0%{opacity:0; transform:scale(.70) rotate(-7deg)}
      60%{opacity:1; transform:scale(1.06) rotate(2deg)}
      100%{opacity:1; transform:scale(1) rotate(0)}
    }

    /* particles */
    .fx{
      position:absolute; inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .p{
      position:absolute;
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.85);
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));
      opacity:0;
      transform:translate(-50%,-50%) scale(.8);
      animation: none;
    }
    .p.star{
      width:auto;height:auto;
      background:transparent;
      font-size:18px;
    }
    @keyframes puff{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.75) rotate(0deg)}
      20%{opacity:1}
      100%{opacity:0; transform:translate(-50%,-90px) scale(1.2) rotate(18deg)}
    }

    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
    }
    #empty{ padding:14px; max-width:260px; }

    /* reduce motion respect */
    @media (prefers-reduced-motion: reduce){
      .progressWrap.wave:after{display:none}
      .node.active .dot:after{animation:none}
      .line > i:after{animation:none}
      #qr.reveal{animation:none; opacity:1; transform:none}
      .stage{transition:none}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="cardHead">
        <h1 class="title">üèÜ Pr√©-inscription ü•ã</h1>
        <p class="sub">Renseigne les infos, puis r√©cup√®re ton QR.</p>
      </div>

      <div class="progressWrap" id="progressWrap">
        <div class="qui" id="qui">
          <div class="node active" data-i="0" aria-label="√âtape 1"><div class="dot"></div></div>
          <div class="line" data-line="0"><i></i></div>

          <div class="node" data-i="1" aria-label="√âtape 2"><div class="dot"></div></div>
          <div class="line" data-line="1"><i></i></div>

          <div class="node" data-i="2" aria-label="√âtape 3"><div class="dot"></div></div>
          <div class="line" data-line="2"><i></i></div>

          <div class="node" data-i="3" aria-label="√âtape 4"><div class="dot"></div></div>
        </div>
      </div>

      <div class="sec">
        <div class="sheet">
          <div class="sheetTop">
            <div class="badge" id="badge">1</div>
            <div class="titles">
              <p class="stepTitle" id="stepTitle">Nom</p>
              <p class="stepSub" id="stepSub">Le nom passe automatiquement en MAJ.</p>
            </div>
          </div>

          <div class="divider"></div>

          <div class="fieldArea" id="fieldArea">
            <div class="stage" id="stage"></div>
          </div>

          <div class="nav">
            <button class="btn" id="backBtn" disabled>Retour</button>
            <button class="btn primary" id="nextBtn" disabled>Suivant</button>
          </div>
        </div>
      </div>

      <div class="qrBox">
        <p class="tip">Astuce üëâ appui long sur le QR ‚Üí <b>Enregistrer l‚Äôimage</b></p>

        <div class="qrFrame">
          <div class="fx" id="fx"></div>
          <img id="qr" alt="QR Code">
          <div id="empty" class="hint">Le QR appara√Ætra ici üéâ</div>
        </div>

        <div class="hint" id="hint"></div>
      </div>

    </div>
  </div>

  <script>
    class ClubsProvider {
      static list() { return ["Paris","Nice","Lyon","Marseille","Lille","Toulouse","Chambly"]; }
    }

    class QrService {
      static url(payload, size = 320) {
        return "https://api.qrserver.com/v1/create-qr-code/?size="
          + size + "x" + size
          + "&data=" + encodeURIComponent(payload);
      }
    }

    class AudioFX {
      // subtle "tink" sound (free, no asset)
      static tink() {
        try{
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          const ctx = new Ctx();

          const o1 = ctx.createOscillator();
          const g1 = ctx.createGain();
          o1.type = "sine";
          o1.frequency.value = 1240;
          g1.gain.value = 0.0001;

          const o2 = ctx.createOscillator();
          const g2 = ctx.createGain();
          o2.type = "sine";
          o2.frequency.value = 1760;
          g2.gain.value = 0.0001;

          o1.connect(g1); g1.connect(ctx.destination);
          o2.connect(g2); g2.connect(ctx.destination);

          const t = ctx.currentTime;
          o1.start(t); o2.start(t);

          g1.gain.exponentialRampToValueAtTime(0.10, t + 0.02);
          g1.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);

          g2.gain.exponentialRampToValueAtTime(0.06, t + 0.02);
          g2.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);

          o1.stop(t + 0.18);
          o2.stop(t + 0.20);
        }catch(e){}
      }
    }

    class VoiceFX {
      static ensureVoicesLoaded(){
        if (!("speechSynthesis" in window)) return;
        // iOS loads voices lazily
        try { window.speechSynthesis.getVoices(); } catch(e){}
      }

      static pickJapaneseVoicePreferMale(){
        if (!("speechSynthesis" in window)) return null;
        const voices = window.speechSynthesis.getVoices?.() || [];
        const ja = voices.filter(v => (v.lang || "").toLowerCase().startsWith("ja"));
        if (!ja.length) return null;

        // Heuristics: prefer names that often correspond to male Japanese voices (varies by OS)
        const maleHints = ["keita","ichiro","otoya","ken","takumi","yamato","hiro","jun","male"];
        const best = ja.find(v => maleHints.some(h => (v.name||"").toLowerCase().includes(h)));
        return best || ja[0];
      }

      static hajimeManga(){
        try{
          if (!("speechSynthesis" in window)) return;
          const u = new SpeechSynthesisUtterance("„ÅØ„Åò„ÇÅ");
          u.lang = "ja-JP";
          // make it more "masculin / manga" (depends on available voices)
          u.pitch = 0.75;
          u.rate  = 0.92;

          const v = VoiceFX.pickJapaneseVoicePreferMale();
          if (v) u.voice = v;

          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(u);
        }catch(e){}
      }
    }

    class Particles {
      static burst(container){
        container.innerHTML = "";
        const W = container.clientWidth || 300;
        const H = container.clientHeight || 300;

        const items = [];
        // few tasteful particles
        for (let i=0;i<7;i++){
          const el = document.createElement("div");
          const isStar = (i % 3 === 0);
          el.className = "p" + (isStar ? " star" : "");
          if (isStar) el.textContent = "‚ú®";
          container.appendChild(el);
          items.push(el);
        }

        items.forEach((el, idx) => {
          const x = 30 + Math.random()*40;   // % around center
          const y = 55 + Math.random()*25;   // %
          el.style.left = x + "%";
          el.style.top  = y + "%";
          el.style.animation = "none";
          // restart animation
          void el.offsetWidth;
          el.style.animation = `puff ${520 + idx*35}ms cubic-bezier(.2,.9,.2,1) forwards`;
          el.style.animationDelay = (idx*22) + "ms";
        });
      }
    }

    class App {
      constructor(){
        this.progressWrap = document.getElementById("progressWrap");
        this.nodes = [...document.querySelectorAll(".node[data-i]")];
        this.lines = [...document.querySelectorAll(".line[data-line] i")];

        this.badge = document.getElementById("badge");
        this.stepTitle = document.getElementById("stepTitle");
        this.stepSub = document.getElementById("stepSub");
        this.fieldArea = document.getElementById("fieldArea");
        this.stage = document.getElementById("stage");

        this.backBtn = document.getElementById("backBtn");
        this.nextBtn = document.getElementById("nextBtn");

        this.qr = document.getElementById("qr");
        this.empty = document.getElementById("empty");
        this.hint = document.getElementById("hint");
        this.fx = document.getElementById("fx");

        this.state = { nom:"", prenom:"", club:"", sexe:"" };
        this.current = 0;
        this.spoken = false;

        this.steps = [
          {
            key:"nom",
            title:"Nom",
            sub:"Le nom passe automatiquement en MAJ.",
            render: () => this.renderInput("nom","JORDAN","family-name"),
            normalize: v => String(v||"").toUpperCase()
          },
          {
            key:"prenom",
            title:"Pr√©nom",
            sub:"Premi√®re lettre automatiquement en majuscule.",
            render: () => this.renderInput("prenom","Mickael","given-name"),
            normalize: v => {
              v = String(v||"").trim();
              if (!v) return "";
              return v.charAt(0).toUpperCase() + v.slice(1);
            }
          },
          {
            key:"club",
            title:"Club",
            sub:"Choisis ton club.",
            render: () => this.renderSelect("club","‚Äî S√©lectionne un club ‚Äî", ClubsProvider.list()),
            normalize: v => String(v||"").trim()
          },
          {
            key:"sexe",
            title:"Sexe",
            sub:"Choisis Masculin ou F√©minin.",
            render: () => this.renderSelect("sexe","‚Äî S√©lectionne ‚Äî", ["Masculin","F√©minin"]),
            normalize: v => String(v||"").trim()
          }
        ];
      }

      init(){
        VoiceFX.ensureVoicesLoaded();

        this.backBtn.addEventListener("click", () => this.go(this.current-1, true));
        this.nextBtn.addEventListener("click", () => this.next());

        // tap on reachable dots
        this.nodes.forEach(n => {
          n.addEventListener("click", () => {
            const i = Number(n.dataset.i);
            const max = this.maxReachableStep();
            if (i <= max) this.go(i, true);
          });
        });

        this.renderStep(this.current, false);
        this.refresh();
      }

      renderStep(i, animateIn=true){
        const step = this.steps[i];
        this.badge.textContent = String(i+1);
        this.stepTitle.textContent = step.title;
        this.stepSub.textContent = step.sub;

        // animate old out then new in
        if (animateIn){
          this.fieldArea.classList.add("in");
          requestAnimationFrame(() => {
            this.stage.innerHTML = "";
            step.render();
            // allow layout
            requestAnimationFrame(() => this.fieldArea.classList.remove("in"));
          });
        } else {
          this.stage.innerHTML = "";
          step.render();
        }
      }

      renderInput(key, placeholder, autocomplete){
        this.stage.innerHTML = `
          <div class="field">
            <input id="field" placeholder="${this.esc(placeholder)}" autocomplete="${this.esc(autocomplete)}" />
            <div class="check" id="check">‚úì</div>
          </div>
        `;
        const input = document.getElementById("field");
        const check = document.getElementById("check");
        input.value = this.state[key] || "";

        const onInput = () => {
          const step = this.steps[this.current];
          const raw = input.value;
          const norm = step.normalize ? step.normalize(raw) : raw;
          if (norm !== raw) input.value = norm;
          this.state[key] = input.value;

          const ok = this.isFilled(input.value);
          check.classList.toggle("show", ok);
          this.refresh();
        };

        input.addEventListener("input", onInput);
        onInput();

        setTimeout(() => {
          try { input.focus({ preventScroll:true }); } catch(e) { input.focus(); }
        }, 70);
      }

      renderSelect(key, firstLabel, options){
        const opts = [
          `<option value="">${this.esc(firstLabel)}</option>`,
          ...options.map(o => `<option value="${this.esc(o)}">${this.esc(o)}</option>`)
        ].join("");

        this.stage.innerHTML = `
          <div class="field select">
            <select id="field">${opts}</select>
            <div class="check" id="check">‚úì</div>
          </div>
        `;

        const select = document.getElementById("field");
        const check = document.getElementById("check");
        select.value = this.state[key] || "";

        const onChange = () => {
          const step = this.steps[this.current];
          this.state[key] = step.normalize ? step.normalize(select.value) : select.value;

          const ok = this.isFilled(select.value);
          check.classList.toggle("show", ok);
          this.refresh();
        };

        select.addEventListener("change", onChange);
        select.addEventListener("input", onChange);
        onChange();

        setTimeout(() => {
          try { select.focus({ preventScroll:true }); } catch(e) { select.focus(); }
        }, 70);
      }

      next(){
        if (!this.isStepOk(this.current)) return;

        AudioFX.tink();

        // mark progress wave + dot pop when the step becomes done
        this.progressWrap.classList.remove("wave");
        void this.progressWrap.offsetWidth;
        this.progressWrap.classList.add("wave");

        // animate field out
        this.fieldArea.classList.add("out");
        setTimeout(() => {
          this.fieldArea.classList.remove("out");

          if (this.current < this.steps.length - 1){
            const prev = this.current;
            this.current++;
            // pop the previous dot as "done"
            this.nodes[prev]?.classList.add("pop");
            setTimeout(() => this.nodes[prev]?.classList.remove("pop"), 280);

            this.renderStep(this.current, true);
            this.refresh();
          } else {
            this.showQR(); // final
          }
        }, 220);
      }

      go(i, animate){
        i = Math.max(0, Math.min(this.steps.length-1, i));
        const max = this.maxReachableStep();
        if (i > max) return;

        if (animate){
          this.fieldArea.classList.add("out");
          setTimeout(() => {
            this.fieldArea.classList.remove("out");
            this.current = i;
            this.renderStep(this.current, true);
            this.refresh();
          }, 200);
        } else {
          this.current = i;
          this.renderStep(this.current, false);
          this.refresh();
        }
      }

      maxReachableStep(){
        for (let i=0;i<this.steps.length;i++){
          if (!this.isStepOk(i)) return i;
        }
        return this.steps.length-1;
      }

      isFilled(v){ return String(v||"").trim().length > 0; }
      isStepOk(i){ return this.isFilled(this.state[this.steps[i].key]); }
      isAllComplete(){ return this.steps.every((_,i)=>this.isStepOk(i)); }

      refresh(){
        const ok = this.isStepOk(this.current);

        this.backBtn.disabled = (this.current === 0);
        this.nextBtn.disabled = !ok;
        this.nextBtn.textContent = (this.current === this.steps.length-1) ? "Terminer" : "Suivant";

        // progress dots + lines (keep done states)
        this.nodes.forEach((n, i) => {
          n.classList.toggle("active", i === this.current);
          n.classList.toggle("done", this.isStepOk(i));
        });
        this.lines.forEach((lineFill, idx) => {
          // line is filled if left step is done
          lineFill.style.width = this.isStepOk(idx) ? "100%" : "0%";
        });

        // if user edits => hide QR
        if (!this.isAllComplete()){
          this.hideQR();
        }
      }

      buildPayload(){
        const n = (this.state.nom||"").trim();
        const p = (this.state.prenom||"").trim();
        const c = (this.state.club||"").trim();
        const s = (this.state.sexe||"").trim();
        return `${n};${p};${c};${s};`;
      }

      showQR(){
        if (!this.isAllComplete()) return;

        const payload = this.buildPayload();

        this.qr.src = QrService.url(payload, 320);
        this.qr.classList.remove("reveal");
        void this.qr.offsetWidth;
        this.qr.classList.add("reveal");

        Particles.burst(this.fx);

        this.qr.style.display = "block";
        this.empty.style.display = "none";
        this.hint.textContent = "QR pr√™t ‚ú®";

        // final voice (needs user gesture: Terminer click is one)
        if (!this.spoken){
          this.spoken = true;
          setTimeout(() => VoiceFX.hajimeManga(), 120);
        }
      }

      hideQR(){
        this.qr.style.display = "none";
        this.qr.classList.remove("reveal");
        this.empty.style.display = "block";
        this.hint.textContent = "";
        this.spoken = false;
      }

      esc(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
    }

    // iOS voices lazy load
    if ("speechSynthesis" in window){
      try { window.speechSynthesis.getVoices?.(); } catch(e){}
      window.speechSynthesis.onvoiceschanged = () => {
        try { window.speechSynthesis.getVoices?.(); } catch(e){}
      };
    }

    new App().init();
  </script>
</body>
</html>